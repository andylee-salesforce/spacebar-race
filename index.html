<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Spacebar Race (P2P – up to 12 players)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif; }
    body { margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 14px; font-size: 28px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; margin: 12px 0; }
    label { display:block; margin: 8px 0 4px; font-size: 14px; color: #cbd5e1; }
    input[type=text], input[type=number] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background:#0b1220; color:#e2e8f0; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; background: #2563eb; color: white; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:260px; }
    .players { display:flex; flex-direction:column; gap:10px; }
    .player { background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:10px; }
    .phead { display:flex; justify-content:space-between; font-size:14px; color:#cbd5e1; margin-bottom:6px; }
    .bar { height:12px; background:#111827; border:1px solid #1f2937; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:#22c55e; transition:width 80ms linear; }
    .badge { background:#0ea5e9; color:#03202f; border-radius:6px; padding:2px 6px; font-size:12px; }
    .muted { color:#94a3b8; font-size:14px; }
    .rowline { display:flex; justify-content:space-between; align-items:center; }
    .winner { font-size:18px; color:#fbbf24; font-weight:600; }
    .hosttag { font-size:11px; background:#f59e0b; color:#2b1800; border-radius:6px; padding:2px 6px; margin-left:8px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:20px; letter-spacing:1px; }
    .k { background:#0b1220; border-radius:6px; padding:2px 6px; border:1px solid #1f2937; }
    .hint { font-size:13px; color:#a3a3a3; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Spacebar Race (P2P)</h1>
    <div id="lobby" class="card">
      <div class="row">
        <div class="col">
          <h3>Create / Join</h3>
          <label>Display name</label>
          <input id="name" type="text" placeholder="Your name" />
          <label>Room code</label>
          <input id="code" type="text" maxlength="4" placeholder="ABCD" />
          <button id="enter">Enter Room</button>
          <div class="hint">Tip: make a new code like <b>RACE</b> or <b>NYC1</b> and share it.</div>
        </div>
        <div class="col">
          <h3>Settings (host only)</h3>
          <label>Clicks to win</label>
          <input id="target" type="number" value="40" min="1" max="200" />
          <button id="applyTarget">Apply</button>
          <div class="hint">Earliest person in the room is the Host.</div>
        </div>
      </div>
      <p class="muted">Up to 12 players. Fully browser-based. Share this link + a 4-letter code.</p>
    </div>

    <div id="room" class="card" style="display:none;">
      <div class="rowline">
        <div>
          <div>Room <span class="code" id="roomCode">----</span> • <span id="youLabel" class="muted"></span></div>
          <div class="muted" id="roomStatus">Waiting for players…</div>
        </div>
        <div>
          <span id="hostBadge" class="hosttag" style="display:none;">Host</span>
          <button id="startBtn" disabled>Start</button>
          <button id="resetBtn" disabled>Reset</button>
        </div>
      </div>
      <div style="margin:10px 0;">
        <span class="muted">Goal:</span> <span id="goalText">40</span> clicks
      </div>
      <div class="players" id="players"></div>
      <div class="card" style="background:#0b1220; margin-top:12px;">
        <div class="rowline">
          <div><b>Gameplay:</b> Press <span class="k">Space</span> to advance. Don’t hold it.</div>
          <div id="winner" class="winner" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <b>How it works:</b> P2P WebRTC using public <code>y-webrtc</code> signaling servers. No server to install.
    </div>
  </div>

  <!-- Pinned, widely-allowed CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.6/dist/y-webrtc.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const els = {
      lobby: $('lobby'), name: $('name'), code: $('code'), enter: $('enter'),
      target: $('target'), applyTarget: $('applyTarget'),
      room: $('room'), roomCode: $('roomCode'), roomStatus: $('roomStatus'),
      players: $('players'), startBtn: $('startBtn'), resetBtn: $('resetBtn'),
      hostBadge: $('hostBadge'), goalText: $('goalText'), winner: $('winner'),
      youLabel: $('youLabel')
    };

    const state = {
      roomCode: null, target: 40, started: false, finishedId: null,
      me: { id: null, name: '' }, players: new Map(), joinOrder: [], MAX_PLAYERS: 12
    };

    function escapeHTML(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
    function isHost(id){ return state.joinOrder[0] === id; }
    function clamp(min,max,v){ return Math.max(min,Math.min(max,v)); }
    function short(id){ return String(id).slice(0,4).toUpperCase(); }

    function render(){
      els.goalText.textContent = state.target;
      els.roomCode.textContent = state.roomCode || '----';
      const list = [...state.players.values()].sort((a,b)=> b.clicks-a.clicks || a.joinedAt-b.joinedAt);
      els.players.innerHTML = '';
      list.forEach(p=>{
        const wrap=document.createElement('div'); wrap.className='player';
        const pct = Math.min(100, Math.round((p.clicks/state.target)*100));
        wrap.innerHTML = `
          <div class="phead">
            <div>${escapeHTML(p.name)} ${isHost(p.id)?'<span class="hosttag">Host</span>':''}</div>
            <div>${p.clicks}/${state.target} <span class="badge">${pct}%</span></div>
          </div>
          <div class="bar"><div class="fill" style="width:${pct}%;"></div></div>
          <div class="muted">${p.connected?'Online':'Disconnected'}</div>`;
        els.players.appendChild(wrap);
      });

      if (state.finishedId){
        const win = state.players.get(state.finishedId);
        els.winner.style.display='block';
        els.winner.textContent = win ? `${win.name} wins!` : 'Winner!';
        els.roomStatus.textContent='Finished';
      } else if (state.started){
        els.winner.style.display='none';
        els.roomStatus.textContent='Race in progress — press Space!';
      } else {
        els.winner.style.display='none';
        const online=[...state.players.values()].filter(p=>p.connected).length;
        els.roomStatus.textContent = online<2?'Waiting for at least 2 players…':'Ready to start';
      }

      const onlineCount=[...state.players.values()].filter(p=>p.connected).length;
      els.startBtn.disabled = !(isHost(state.me.id) && !state.started && !state.finishedId && onlineCount>=2);
      els.resetBtn.disabled = !isHost(state.me.id);
      els.hostBadge.style.display = isHost(state.me.id)?'inline-block':'none';
      els.youLabel.textContent = `You: ${state.me.name||'(no name)'}`;
    }

    // --- Networking via Yjs + y-webrtc ---
    let doc, awareness, provider, roomName, updates = {};
    // Shared Y.Map schema:
    // { target:number, started:boolean, finishedId:string|null, joinOrder:Array<string>,
    //   players: { [id]: { name, clicks, joinedAt, connected } } }

    function enterRoom(){
      const name = els.name.value.trim() || 'Player';
      const code = (els.code.value.trim() || '').toUpperCase();
      if (!code || code.length!==4) return alert('Enter a 4-letter room code');

      // store url hash for convenience
      location.hash = `name=${encodeURIComponent(name)}&code=${encodeURIComponent(code)}`;

      state.me.name = name;
      state.roomCode = code;

      roomName = `spacebar-race-v2-${code}`;
      doc = new Y.Doc();

      provider = new window.ywebrtc.WebrtcProvider(roomName, doc, {
        // public signaling servers (multiple for reliability)
        signaling: [
          'wss://signaling.yjs.dev',
          'wss://y-webrtc-signaling-eu.herokuapp.com',
          'wss://y-webrtc-signaling-us.herokuapp.com'
        ],
        // common STUN
        rtcConfig: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
      });

      awareness = provider.awareness;

      const root = doc.getMap('root');
      if (!root.has('players')) root.set('players', new Y.Map());
      if (!root.has('joinOrder')) root.set('joinOrder', new Y.Array());
      if (!root.has('target')) root.set('target', 40);
      if (!root.has('started')) root.set('started', false);
      if (!root.has('finishedId')) root.set('finishedId', null);

      const playersMap = root.get('players');
      const joinOrder = root.get('joinOrder');

      // my id (awareness client id is numeric, make a string)
      state.me.id = String(provider.awareness.clientID);

      doc.transact(()=>{
        if (!playersMap.has(state.me.id)) {
          playersMap.set(state.me.id, new Y.Map());
          const me = playersMap.get(state.me.id);
          me.set('name', name);
          me.set('clicks', 0);
          me.set('joinedAt', Date.now());
          me.set('connected', true);
          joinOrder.push([state.me.id]);
        } else {
          playersMap.get(state.me.id).set('connected', true);
        }
      });

      // apply remote -> local
      function syncFromDoc(){
        state.target = root.get('target');
        state.started = root.get('started');
        state.finishedId = root.get('finishedId');
        state.joinOrder = joinOrder.toArray().map(x=>x[0]);

        state.players = new Map();
        playersMap.forEach((ymap, pid)=>{
          state.players.set(pid, {
            id: pid,
            name: ymap.get('name'),
            clicks: ymap.get('clicks')|0,
            joinedAt: ymap.get('joinedAt')|0,
            connected: !!ymap.get('connected')
          });
        });
        render();
      }
      syncFromDoc();
      root.observeDeep(syncFromDoc);

      provider.on('peers', ()=>render());
      provider.on('status', ()=>render());

      els.lobby.style.display='none';
      els.room.style.display='block';
      render();
    }

    // UI handlers
    els.enter.addEventListener('click', enterRoom);
    els.applyTarget.addEventListener('click', ()=>{
      if (!doc) return;
      const t = clamp(1,200, parseInt(els.target.value,10)||40);
      doc.getMap('root').set('target', t);
    });
    els.startBtn.addEventListener('click', ()=>{
      if (!doc || !isHost(state.me.id)) return;
      const root = doc.getMap('root');
      const playersMap = root.get('players');
      doc.transact(()=>{
        root.set('started', true);
        root.set('finishedId', null);
        playersMap.forEach(p => p.set('clicks', 0));
      });
    });
    els.resetBtn.addEventListener('click', ()=>{
      if (!doc || !isHost(state.me.id)) return;
      const root = doc.getMap('root');
      const playersMap = root.get('players');
      doc.transact(()=>{
        root.set('started', false);
        root.set('finishedId', null);
        playersMap.forEach(p => p.set('clicks', 0));
      });
    });

    // Spacebar gameplay
    let lastDownAt = 0;
    window.addEventListener('keydown', (e)=>{
      if (e.code==='Space'){
        e.preventDefault();
        if (!doc || !state.started || state.finishedId) return;
        const t = performance.now();
        if (t-lastDownAt < 15) return;
        lastDownAt = t;

        const root = doc.getMap('root');
        const playersMap = root.get('players');
        const me = playersMap.get(state.me.id);
        const next = Math.min(root.get('target'), (me.get('clicks')|0)+1);
        me.set('clicks', next);

        if (next >= root.get('target') && !root.get('finishedId')){
          root.set('finishedId', state.me.id);
          root.set('started', false);
        }
      }
    }, { passive:false });

    // load name/code from url hash for convenience
    (function hydrate(){
      try {
        const p=new URLSearchParams(location.hash.slice(1));
        if (p.get('name')) $('name').value=p.get('name');
        if (p.get('code')) $('code').value=p.get('code');
      } catch {}
    })();
  </script>
</body>
</html>
